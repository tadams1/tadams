<html>
  <title>Shorebird Maps</title>
  <link href="stylesheets/style.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQ6LMGS6ebrYR_ABSnMfudwc7sgwgoTWg"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script type="text/javascript">

      var theMap;
      var thePoints;
      var theMarker;
      var formattedAddr;

      var pageInfo = {
        "threats": 
           [
            {
              "id": "IndDev",
              "text": "Industrial Development"
            },
            {
              "id": "ResDev",
              "text": "Residental Development"
           },
           {
              "id": "OffLeashDogs",
              "text": "Off Leash Dogs"
           },
           {
              "id": "BadWaterMgmt",
              "text": "Bad Water Management"
           }
           ],
        "actions": 
          [
            {
              "id": "action1",
              "text": "Jane Small"
            },
            {
              "id": "action2",
              "text": "actionzzz"
            }
          ],
          "layers":
          [
            {
              "id": "F",
              "text": "Important Bird Areas"
            },
            {
              "id": "o",
              "text": "Ramsar Sites"
            }
          ]
      };
    

      function initialize() {
 	      
        var mapOptions = {
          zoom: 4,
          center: {lat: -28, lng: 137.883},
    		  mapTypeId: google.maps.MapTypeId.TERRAIN
  		  };

        theMap = new google.maps.Map(document.getElementById('map'), mapOptions);
      
        //theMap.data.addGeoJson(<%- points %>);
        thePoints = <%- points %>;
   	    //theMap.data.addGeoJson(<%- polygons %>);
        //theMap.data.loadGeoJson("http://localhost:3000/maps?geotype=Point&type=OffLeashDogs")
  
        theMap.data.addListener('dblclick', function(event) {
          var myHTML = event.feature.getProperty("infobox");
          infowindow.setContent("<div style='width:150px; text-align: center;'>"+myHTML+"</div>");
          //alert(JSON.stringify(event.feature.getGeometry().getArray().getArray()));
          infowindow.setPosition(event.latLng);
          infowindow.setOptions({pixelOffset: new google.maps.Size(0,-30)});
          infowindow.open(theMap);
        });
 
        theMap.addListener('click', function(event) {
          infowindow.setContent("<div style='width:150px; text-align: center;'>Add bird here</div>");
          infowindow.setPosition(event.latLng);
          infowindow.setOptions({pixelOffset: new google.maps.Size(0,-30)});
          infowindow.open(theMap);

          var tb1 = document.getElementById('Lat');
          tb1.value = event.latLng.lat();
          tb1 = document.getElementById('Lng');
          tb1.value = event.latLng.lng();
        });

        var callback=function(feature) {
          theMap.data.setStyle(function(feature) {
          return {icon:feature.getProperty('icon')};
        });

        
      }

      buildPage('threat', pageInfo.threats);
      buildPage('action', pageInfo.actions);
      buildPage('layers', pageInfo.layers);
      theMap.data.forEach(callback);
    }

    function buildPage(thename, thearray) {
      var tchk = $('#' + thename + 'typechk');
      tchk.append('<ul class="' + thename + '-checkbox">');
      var featureType;
      if(thename=="layers"){
        featureType = "Polygon";
      }else{
        featureType = "Point";
      }
      for(var i = 0; i < thearray.length; i++) {
          tchk.append('<li><input type="checkbox" onclick=updateJSON(this,"' + featureType + '","' + thearray[i].id + '") + id="' + thename  + i + '" value="' + thearray[i].id + '" /><label for="' + thename + i + '">' + thearray[i].text + '</label></li>');
      }
      tchk.append('</ul>');      
    }


    google.maps.event.addDomListener(window, 'load', initialize);

    function updateJSON(chkbox, geotype, dbtype) {
      if(chkbox.checked) {
        theMap.data.loadGeoJson('http://localhost:3000/maps?geotype=' + geotype + '&type='+ dbtype);
      }else{
        var callback=function(feature) {
          
          if(feature.getProperty('type') == dbtype || feature.getProperty('letter') == dbtype) {
            theMap.data.remove(feature);
          }
        };
        theMap.data.forEach(callback);
      }
    }

    

</script>


<body>
  <div class="wrapper">
    <div class="inner-wrapper">
        <div class="left pane">
      <div id="threat-tab1" class="vrthreat-panel1">
        <p>Threats</p>
       <div id='threattypechk'></div>
      </div>
      <div id="threat-tab2" class="vrthreat-panel2">
        <p>Actions</p>
        <div id='actiontypechk'></div>
      </div>
        </div>
        <div class="center pane" id="map">
        </div>
        <div class="right pane">
        <div id="threat-tab1" class="vrthreat-panel1">
        <p>Layers</p>
        <div id='layerstypechk'></div>
        </div>
        </div>
    </div>
</div>
</body>
</html> 	